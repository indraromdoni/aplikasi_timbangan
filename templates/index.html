<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aplikasi Timbangan</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  <!--script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 1rem; }
    .navbar-brand { font-weight: bold; }
    .weight-display {
      font-size: 3rem;
      font-weight: bold;
      text-align: right;
      color: #0d6efd;
      letter-spacing: 2px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ðŸ“¦ Aplikasi Timbangan</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="/">Timbangan</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Data Master</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/data_produk">Produk</a></li>
              <li><a class="dropdown-item" href="/data_wadah">Wadah</a></li>
              <li><a class="dropdown-item" href="/data_pengguna">Pengguna</a></li>
              <li><a class="dropdown-item" href="/data_supplier">Supplier</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="/config">Konfigurasi</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"><i class="bi bi-person-circle"></i></a>
            <ul class="dropdown-menu dropdown-menu-end">
              {% if user %}
              <li><span class="dropdown-item-text">Halo, {{ user }}</span></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
              {% else %}
              <li><a class="dropdown-item" data-bs-toggle="modal" data-bs-target="#myModal" href="#">Login</a></li>
              {% endif %}
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Modal login -->
  <div class="modal fade" id="myModal">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">LOGIN</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          
          <form id="formLogin">
            <div class="row">
              <div class="row">
                <label>Nama Pengguna</label>
                <input type="text" name="username" class="form-control" placeholder="Masukan nama pengguna">
              </div>
              <div class="row">
                <label>Password</label>
                <input type="password" name="password" class="form-control" placeholder="Masukan kata sandi">
              </div>
              <div class="row mt-3 gap-2 d-flex justify-content-center">
                <div class="col">
                  <button type="submit" class="btn btn-primary w-100">Masuk</button>
                </div>
                <div class="col">
                  <button type="reset" class="btn btn-danger w-100" data-bs-dismiss="modal" id="btnLoginCancel">Batal</button>
                </div>
              </div>
            </div>
          </form>

        </div>

        <!-- Modal footer 
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>-->

      </div>
    </div>
  </div>

  <div class="container">
    <div id="myAlert" class="alert alert-success fade" role="alert" style="display:none;"></div>
    <div class="row">

      <!-- 4ï¸âƒ£ Proses Penimbangan -->
      <div id="timbang" class="col-sm-3 p-4 mb-4">
        <h4>Proses Penimbangan</h4>
        <form id="formTimbang">
          <div class="row">
            <div class="row">
              <label>Produk</label>
              <select id="produk" name="produk" class="form-select" required>
                <option value="produk1">Kaleng</option>
                <option value="produk2">PC</option>
                <option value="produk3">Produk 3</option>
              </select>
            </div>
            <div class="row">
              <label>Wadah</label>
              <select id="wadah" name="wadah" class="form-select" required>
                <option value="pallet">Pallet</option>
                <option value="jumbo">Jumbo Bag</option>
                <option value="karung">Karung</option>
              </select>
            </div>
            <div class="row">
              <label>Berat Gross(kg)</label>
              <div class="weight-display" id="beratDisplay">0.00</div>
            </div>
            <div class="row">
              <label>Berat Tare(kg)</label>
              <div class="weight-display" id="beratTare">0.00</div>
            </div>
            <div class="row">
              <label>Berat Nett(kg)</label>
              <div class="weight-display" id="beratNett">0.00</div>
            </div>
          </div>
          <!--div class="d-flex justify-content-end gap-2 mt-3">
            <button type="submit" class="btn btn-primary">Simpan</button>
            <button type="button" class="btn btn-success" id="btnPrint">Print Out</button>
          </div-->
        </form>
        <small class="text-muted mt-3 d-block">
          Status koneksi: <span id="statusWebsocket">Menunggu koneksi...</span>
        </small>
      </div>

      <!-- Riwayat Timbangan -->
      <div id="riwayat" class="col card p-4 mb-5">
        {% if user %}
        <div>
          <button type="button" class="btn btn-warning" id="btnTransaksi"><i class="bi bi-plus"></i></button>
        </div>
        {% else %}
        <div data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Silakan login untuk mengaktifkan tombol.">
          <button type="button" class="btn btn-warning" id="btnTransaksi" disabled><i class="bi bi-plus"></i></button>
        </div>
        {% endif %}
        <ul class="nav nav-tabs" id="transaksiTabs">
          <!--Tempat tab-->
        </ul>
        <div class="tab-content" id="transaksiContent">
          <!--Tempat konten tab-->
        </div>
        <!--div>
          <table id="tblRiwayat" class="table table-bordered table-hover w-100"></table>
        </div-->
      </div>
    </div>
  </div>

  <!-- Modal tambah data -->
  <div class="modal fade" id="ModalTambahData">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Transaksi Baru</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          
          <form id="formTransaksi" class="row g-2">
            <div class="row">
              <label>Suplier</label>
              <select id="supplier" name="supplier" class="form-select" required>
                <option value="abc">PT. ABC</option>
                <option value="def">DEF</option>
                <option value="ghi">GHI</option>
              </select>
            </div>
            <div class="row">
              <label>No. Polisi</label>
              <input type="text" id="nopol" name="nopol" class="form-control" placeholder="B 1234 XYZ" required>
            </div>
            <div class="row">
              <label>Driver</label>
              <input type="text" name="driver" class="form-control" placeholder="Masukan nama driver" required>
            </div>
            <div class="col-md-12"><button type="button" id="btnSubmitTransaksi" class="btn btn-success w-100">Simpan</button></div>
          </form>

        </div>

        <!-- Modal footer 
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>-->

      </div>
    </div>
  </div>

  <template id="tab-template">
    <div class="tab-pane p-3" style="display: none;">
      <div class="row mb-2">
        <div class="col-md-4"><b>Supplier:</b><br> <span class="t-supplier"></span></div>
        <div class="col-md-2"><b>Nopol:</b><br> <span class="t-nopol"></span></div>
        <div class="col-md-2"><b>Driver:</b><br> <span class="t-driver"></span></div>
        <div class="col-md-4 text-end">
          <button class="btn btn-sm btn-success btn-add-weight">Tambah Berat</button>
          <button class="btn btn-sm btn-danger btn-close-trans">Close</button>
        </div>
      </div>
      <table class="table table-striped" width="100%" id="table-local"></table>
    </div>
  </template>

  <!-- Modal hapus data -->
  <div class="modal fade" id="ModalHapusData">
    <div class="modal-dialog">
      <div class="modal-content">

        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Hapus Data</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal body -->
        <div class="modal-body">
          
          <p>Apakah Anda yakin ingin menghapus data ini?</p>
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="button" class="btn btn-danger" id="btnHapus">Hapus</button>
          </div>

        </div>

        <!-- Modal footer 
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
        </div>-->

      </div>
    </div>
  </div>

  <!-- Bootstrap + jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  

  <!-- Script utama -->
  <script>
    $(document).ready(function(){
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      })
    });    

    // WebSocket
    const socket = io(`${window.location.hostname}:5000`);
    socket.on('connect', () => {
      $("#statusWebsocket").text("Terkoneksi");
      socket.emit('test', 'testing'); // Untuk testing koneksi
    });
    socket.on('disconnect', () => {
      $("#statusWebsocket").text("Terputus. Mencoba koneksi ulang...");
    });
    socket.on('serial_data', (msg) => {
      $("#beratDisplay").text(msg);
      let tare = parseFloat($("#beratTare").text());
      let gross = parseFloat(msg);
      let nett = gross - tare;
      $("#beratNett").text(nett.toFixed(2));
    });
    
    function fetchDataMaster() {
      $.ajax({
        type: "GET",
        url: "/api/master_data",
        success: function(response) {
          // Perbarui dropdown produk
          let produkOptions = '';
          produkOptions += `<option value="" disabled selected>-- Pilih Produk --</option>`;
          response.produk.forEach(item => {
            produkOptions += `<option value="${item.nama_produk}">${item.nama_produk}</option>`;
          });
          $('#produk').html(produkOptions);

          // Perbarui dropdown wadah
          let wadahOptions = '';
          wadahOptions += `<option value="" disabled selected>-- Pilih Wadah --</option>`;
          response.wadah.forEach(item => {
            wadahOptions += `<option value="${item.berat_kosong}">${item.nama_wadah}</option>`;
          });
          $('#wadah').html(wadahOptions);

          // Perbarui dropdown supplier
          let supplierOptions = '';
          supplierOptions += `<option value="" disabled selected>-- Pilih Supplier --</option>`;
          response.supplier.forEach(item => {
            supplierOptions += `<option value="${item.nama}">${item.nama}</option>`;
          });
          $('#supplier').html(supplierOptions);
        },
        error: function() {
          showAlert("Gagal mengambil data master.");
        }
      });
    }
    fetchDataMaster();

    $('#wadah').on('change', function() {
      const selectedWadah = $(this).val();
      $('#beratTare').text(selectedWadah)
    });

    const modal = new bootstrap.Modal(document.getElementById('ModalTambahData'));
    $('#btnTransaksi').on('click', () => { $('#formTransaksi')[0].reset(); modal.show(); });
    $('#btnSubmitTransaksi').on('click', () => {
      const f = $('#formTransaksi').serializeArray();
      const payload = {};
      f.forEach(i => payload[i.name] = i.value);
      fetch('/api/transaksi', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
        .then(r => r.json()).then(x => {
          if (x.status == 'success') {
            addTab(x, true); // x is object; but our api returns keys at top-level; we will refetch
            modal.hide();
            fetchTransaksiAndRender();
          } else {
            alert('Gagal buat transaksi: ' + (x.error || JSON.stringify(x)));
          }
        });
    });

    function fetchTransaksiAndRender() {
      fetch('/api/transaksi')
        .then(r => r.json())
        .then(list => {
          $('#transaksiTabs').empty();
          $('#transaksiContent').empty();
          // render each transaksi
          list.forEach(t => addTab(t, false));
          if (list.length) openTab(list[0].id_transaksi);
        });
    }
    const user = "{{ user }}";
    if(user != "None") {
      fetchTransaksiAndRender();
    }

    function get_alat_ukur() {
      const produk = $('#produk').val();
      const wadah = $('#wadah').val();
      const w_kotor = $('#beratDisplay').text();
      const w_tare = $('#beratTare').text();
      const w_nett = $('#beratNett').text();
      const data = {produk, wadah, w_kotor, w_tare, w_nett};
      console.log(data)
      return data
    }

    function addTab(t, makeActive=true) {
      const tabId = 'tab-' + t.id_transaksi;
      const contentId = 'content-' + t.id_transaksi;

      const $li = $(`<li class="nav-item"><a class="nav-link" id="${tabId}" href="#">${t.supplier}</a></li>`);
      $li.find('a').on('click', (e) => { e.preventDefault(); openTab(t.id_transaksi); });
      $('#transaksiTabs').append($li);

      const tpl = document.getElementById('tab-template').content.cloneNode(true);
      const $content = $(tpl).children().first();
      $content.attr('id', contentId);
      $content.find('.t-supplier').text(t.supplier || '-');
      $content.find('.t-nopol').text(t.nopol || '-');
      $content.find('.t-driver').text(t.driver || '-');

      const tableId = 'tbl-' + t.id_transaksi;
      $content.find('#table-local').attr('id', tableId);

      $content.find('.btn-add-weight').on('click', function() {
        const {produk, wadah, w_kotor, w_tare, w_nett} = get_alat_ukur();
        saveWeightToTransaksi(
          t.id_transaksi, 
          { 
            produk: produk, 
            wadah: wadah, 
            berat_kotor: parseFloat(w_kotor), 
            berat_tare: parseFloat(w_tare), 
            berat_nett: parseFloat(w_nett), 
            operator: '{{ user }}', 
            supplier: t.supplier, 
            driver: t.driver, 
            nopol: t.nopol
          })
      });
      $content.find('.btn-close-trans').on('click', () => onCloseTrans(t.id_transaksi));

      $('#transaksiContent').append($content);

      $(`#${tableId}`).DataTable({
        ajax: { url: `/api/transaksi/${t.id_transaksi}/timbang`, dataSrc: '' },
        columns: [
          { data: 'waktu', title: 'Waktu' },
          { data: 'wadah', title: 'Wadah' },
          { data: 'produk', title: 'Produk' },
          { data: 'berat_kotor', title: 'Berat Kotor' },
          { data: 'berat_tare', title: 'Berat Tare' },
          { data: 'berat_nett', title: 'Berat Nett' },
          { data: 'remarks', title: 'Keterangan',
            render: function(data, type, row) {
              return `<input type="text" class="form-control remarks-input" data-id="${row.id}" data-transaksi="${t.id_transaksi}" value="${data || ''}">`;}
          }
        ]
      });

      if (makeActive) openTab(t.id_transaksi);
    }

    $(document).on('change', '.remarks-input', function() {
        const id = $(this).data('id');
        const id_transaksi = $(this).data('transaksi');
        const value = $(this).val();

        fetch(`/api/timbang/${id}/remarks`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ remarks: value })
        })
        .then(res => res.json())
        .then(result => {
            console.log("Updated:", result);
            $(`#tbl-${id_transaksi}`).DataTable().ajax.reload();
        })
        .catch(err => console.error(err));
    });

    function openTab(id) {
      $('#transaksiContent').children().hide();
      $('#transaksiTabs').find('.nav-link').removeClass('active');
      $('#content-' + id).show();
      $('#tab-' + id).addClass('active');
      activeTransaksi = id;
      const t = $(`#tbl-${id}`).DataTable();
      if (t) t.ajax.reload();
    }

    function onAddWeight(id, payload) {
      const produk = $('#produk').val();
      const wadah = $('#wadah').val();
      const w_kotor = $('#beratDisplay').text();
      const w_tare = $('#beratTare').text();
      const w_nett = $('#beratNett').text();
      saveWeightToTransaksi(t.id_transaksi, { produk: produk, wadah: wadah, berat_kotor: parseFloat(w_kotor), berat_tare: parseFloat(w_tare), berat_nett: parseFloat(w_nett), operator: '{{ user }}', supplier: t.supplier, driver: t.driver, nopol: t.nopol });
    }

    function onCloseTrans(id) {
      if (!confirm('Tutup transaksi ini?')) return;
      fetch(`/api/transaksi/${id}/close`, { method: 'POST' })
        .then(r => r.json()).then(x => { if (x.status == 'success') fetchTransaksiAndRender(); });
    }

    function saveWeightToTransaksi(id_transaksi, payload) {
      fetch(`/api/transaksi/${id_transaksi}/timbang`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r => r.json()).then(x => {
        if (x.status == 'success') {
          $(`#tbl-${id_transaksi}`).DataTable().ajax.reload();
        } else {
          alert('Gagal simpan: ' + (x.error || JSON.stringify(x)));
        }
      });
    }

    function closeTab(id) {
      console.log("close "+id);
      $('#tabTransaksi'+id).remove();
      $('#new'+id).remove();
      const lastTab = $('#tabTransaksi .nav-link').last();
      if (lastTab.length) {
        new bootstrap.Tab(lastTab[0]).show();
      }
    }
    function hapusData(id, supplier, tgl) {
      $('#ModalHapusData').attr('data-id', id);
      $('#ModalHapusData').attr('data-supplier', supplier);
      $('#ModalHapusData p').html(`Apakah Anda yakin ingin menghapus data <span class="fw-bold text-danger">${supplier}</span>?`);
      $('#ModalHapusData').modal('show');
    }
    
    $('#btnHapus').on('click', function() {
      const id = $('#ModalHapusData').attr('data-id');
      const supplier = $('#ModalHapusData').attr('data-supplier');
      $.ajax({
        type: "DELETE",
        url: `/api/riwayat_timbang/${id}`,
        success: function(response) {
          showAlert("Data berhasil dihapus.");
          const date = new Date();
          const shortDate = date.toISOString().split('T')[0]; // "YYYY-MM-DD"
          tblRiwayat.clear().draw();
          get_data_timbangan(tblRiwayat, supplier, shortDate);
        },
        error: function() {
          showAlert("Gagal menghapus data.");
        }
      });
      $('#ModalHapusData').modal('hide');
    });

    $("#formLogin").on("submit", function(e){
      e.preventDefault();
      const formData = {
        username: $(this).find('input[name="username"]').val(),
        password: $(this).find('input[name="password"]').val()
      };
      //console.log(formData)
      $.ajax({
        type: "POST",
        url: "/api/login",
        data: JSON.stringify(formData),
        contentType: "application/json",
        success: function(response) {
          showAlert(`Selamat datang ${formData.username}!`);
          $('#myModal').modal('hide');
          setTimeout(() => {
            location.reload();
          }, 1000);
        },
        error: function() {
          showAlert("Login gagal. Periksa kembali kredensial Anda.");
        }
      });
    });

    function logout() {
      $.ajax({
        type: "POST",
        url: "/api/logout",
        success: function(response) {
          showAlert("Anda telah logout.");
          setTimeout(() => {
            location.reload();
          }, 1000);
        },
        error: function() {
          showAlert("Logout gagal.");
        }
      });
    }

    function showAlert(message, type = 'success') {
      //console.log('Showing alert:', message, 'Type:', type);
      const alertDiv = $('#myAlert');

      alertDiv
        .removeClass('alert-success alert-danger alert-warning alert-info')
        .addClass(`alert-${type} fade`)  // pastikan ada fade
        .text(message);

      alertDiv.show();

      // fade-in
      setTimeout(() => {
        alertDiv.addClass('show');
      }, 30);

      // fade-out + hide
      setTimeout(() => {
        alertDiv.removeClass('show');
        setTimeout(() => alertDiv.hide(), 300); // tunggu animasi 300ms
      }, 3000);
    }
  </script>

</body>
</html>
